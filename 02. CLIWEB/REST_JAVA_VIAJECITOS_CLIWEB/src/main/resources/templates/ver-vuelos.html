<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Vuelos disponibles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        .asiento {
            width: 40px;
            height: 40px;
            background-color: #90ee90;
            border: 1px solid #333;
            text-align: center;
            line-height: 40px;
            margin: 3px;
            cursor: pointer;
            display: inline-block;
            border-radius: 4px;
            font-weight: bold;
        }

        .asiento input[type=checkbox] {
            display: none;
        }

        .asiento label {
            cursor: pointer;
            display: block;
            width: 100%;
            height: 100%;
        }

        .asiento input[type=checkbox]:checked + label {
            background-color: #0275d8;
            color: white;
        }

        .asiento.ocupado {
            background-color: #d9534f;
            color: white;
            cursor: not-allowed;
        }

        .asiento.reservado {
            background-color: #f0ad4e;
            color: black;
            cursor: not-allowed;
        }

        .asiento.pagado {
            background-color: #d9534f;
            color: white;
            cursor: not-allowed;
        }

        .fila {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
            }
        }

        input[type="text"], input[type="date"] {
            max-width: 250px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">
    <h2 class="text-center mb-4">Vuelos Disponibles</h2>

    <!-- Filtros -->
    <div class="row g-3 mb-4">
        <div class="col-md-4 col-sm-12">
            <input type="text" id="filtroOrigen" class="form-control" placeholder="Filtrar por origen..." onkeyup="filtrar()" />
        </div>
        <div class="col-md-4 col-sm-12">
            <input type="text" id="filtroDestino" class="form-control" placeholder="Filtrar por destino..." onkeyup="filtrar()" />
        </div>
        <div class="col-md-4 col-sm-12">
            <input type="date" id="filtroFecha" class="form-control" oninput="filtrar()" />
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive">
        <table id="tablaVuelos" class="table table-striped table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Fecha y Hora</th>
                    <th>Capacidad</th>
                    <th>Disponibles</th>
                    <th>Precio</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="vuelo : ${vuelos}"
                    th:if="${vuelo.vueloEstado == 'ACTIVO'} and ${vuelo.vueloFechaSalida} >= ${T(java.time.LocalDateTime).now()}">
                    <td hidden="hidden" th:text="${vuelo.ciudadOrigenCodigo}"></td>
                    <td hidden="hidden" th:text="${vuelo.ciudadDestinoCodigo}"></td>                  <td hidden="hidden" th:text="${vuelo.ciudadOrigenCodigo}"></td>
                    <td th:text="${vuelo.ciudadOrigenNombre}"></td>                  <td hidden="hidden" th:text="${vuelo.ciudadOrigenCodigo}"></td>
                    <td th:text="${vuelo.ciudadDestinoNombre}"></td>
                    <td th:text="${#temporals.format(vuelo.vueloFechaSalida, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${vuelo.totalAsientos}"></td>
                    <td th:text="${vuelo.asientosDisponibles}"></td>
                    <td th:text="${vuelo.vueloValor} + ' USD'"></td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm"
                            th:attr="onclick='abrirModal(' + ${vuelo.vueloId} + ')'">
                            Comprar
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm mt-1"
                                th:attr="onclick='verRutaVuelo(' + ${vuelo.vueloId} + ')'">
                            Ver Ruta
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal container -->
<div id="modalContainer"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function abrirModal(vueloId) {
        fetch('/asientos/vuelo/' + vueloId)
            .then(r => r.text())
            .then(html => {
                const cont = document.getElementById('modalContainer');
                cont.innerHTML = html;

                const modalElement = document.getElementById('modalAsientos');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                }
            });
    }

    function cerrarModal() {
        document.getElementById('modalContainer').innerHTML = '';
    }

    function filtrar() {
        let origen = document.getElementById("filtroOrigen").value.toLowerCase();
        let destino = document.getElementById("filtroDestino").value.toLowerCase();
        let fecha = document.getElementById("filtroFecha").value;

        let filas = document.querySelectorAll("#tablaVuelos tbody tr");

        filas.forEach(fila => {
            let td = fila.querySelectorAll("td");

            let textoOrigen = td[0]?.innerText.toLowerCase() || "";
            let textoDestino = td[1]?.innerText.toLowerCase() || "";
            let textoFecha = td[2]?.innerText.slice(0, 10) || "";

            let coincideOrigen = textoOrigen.includes(origen);
            let coincideDestino = textoDestino.includes(destino);
            let coincideFecha = !fecha || textoFecha === fecha;

            fila.style.display = (coincideOrigen && coincideDestino && coincideFecha) ? "" : "none";
        });
    }
</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Iconos desde CDN
    L.Icon.Default.mergeOptions({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png'
    });

    let map;

    function verRutaVuelo(idVuelo) {
        fetch('/rutaVuelo/' + idVuelo)
            .then(res => res.text())
            .then(html => {
                document.getElementById('modalContainer').innerHTML = html;

                const modalElement = document.getElementById('modalRuta');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();

                modalElement.addEventListener('shown.bs.modal', () => {
                    const datos = document.getElementById('datosRuta');
                    const origen = [parseFloat(datos.dataset.latOrigen), parseFloat(datos.dataset.lonOrigen)];
                    const destino = [parseFloat(datos.dataset.latDestino), parseFloat(datos.dataset.lonDestino)];

                    // üó∫Ô∏è Crear mapa
                    if (map) map.remove(); // destruir mapa anterior
                    map = L.map('map').setView(origen, 5);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    L.marker(origen).addTo(map).bindPopup("Origen").openPopup();
                    L.marker(destino).addTo(map).bindPopup("Destino");
                    L.polyline([origen, destino], { color: 'red' }).addTo(map);

                    // Calcular distancia
                    const dist = calcularDistancia(origen, destino);
                    document.getElementById("distance").innerText = `Distancia aproximada: ${dist} km`;

                    // Ajustar tama√±o del mapa
                    setTimeout(() => map.invalidateSize(), 300);
                }, { once: true });
            });
    }

    function calcularDistancia(coord1, coord2) {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(coord2[0] - coord1[0]);
        const dLon = toRad(coord2[1] - coord1[1]);
        const lat1 = toRad(coord1[0]);
        const lat2 = toRad(coord2[0]);

        const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c).toFixed(2);
    }
</script>



</body>
</html>

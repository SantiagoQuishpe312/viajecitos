<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Vuelos disponibles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        /* Z-index para modal nuevo cliente arriba de otros modales */
        #modalNuevoCliente.modal.show {
            z-index: 1060 !important;
        }

        /* Estilos asientos */
        .asiento {
            width: 40px;
            height: 40px;
            background-color: #90ee90;
            border: 1px solid #333;
            text-align: center;
            line-height: 40px;
            margin: 3px;
            cursor: pointer;
            display: inline-block;
            border-radius: 6px;
            font-weight: 700;
            user-select: none;
            transition: background-color 0.3s, color 0.3s;
        }
        .asiento.ocupado, .asiento.pagado {
            background-color: #d9534f;
            color: white;
            cursor: not-allowed;
        }
        .asiento.reservado {
            background-color: #f0ad4e;
            color: black;
            cursor: not-allowed;
        }
        .fila {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        /* Estilos filtros */
        .filtros-container {
            max-width: 900px;
            margin: 0 auto 30px;
        }
        .filtros-container input {
            box-shadow: 0 3px 8px rgba(13,110,253,0.1);
            transition: box-shadow 0.3s;
        }
        .filtros-container input:focus {
            box-shadow: 0 4px 12px rgba(13,110,253,0.3);
            outline: none;
            border-color: #0d6efd;
        }

        /* Tabla vuelos */
        .table-responsive {
            max-width: 900px;
            margin: 0 auto 40px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: hidden;
        }
        table {
            border-collapse: separate;
            border-spacing: 0 12px;
        }
        thead tr {
            background-color: #e7f1ff;
        }
        thead th {
            font-weight: 700;
            color: #0d6efd;
            text-transform: uppercase;
            font-size: 0.9rem;
            border-bottom: none;
            vertical-align: middle;
            padding: 14px 12px;
        }
        tbody tr {
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        tbody tr:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(13,110,253,0.15);
        }
        tbody td {
            vertical-align: middle;
            padding: 14px 12px;
            font-weight: 600;
            color: #333;
        }

        /* Botones */
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(13,110,253,0.3);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .btn-primary:hover {
            background-color: #084cdf;
            border-color: #084cdf;
            box-shadow: 0 6px 12px rgba(8,76,223,0.5);
        }
        .btn-outline-info {
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }
        .btn-outline-info:hover {
            background-color: #0dcaf0;
            color: white;
            border-color: #0dcaf0;
        }

        /* Responsive para dispositivos móviles */
        @media (max-width: 768px) {
            .filtros-container {
                padding: 0 15px;
            }
            .table-responsive {
                max-width: 100%;
                margin-bottom: 25px;
            }
            tbody td, thead th {
                padding: 12px 8px;
                font-size: 0.85rem;
            }
            .btn-primary, .btn-outline-info {
                font-size: 0.85rem;
                padding: 8px 12px;
            }
        }

        @media (max-width: 480px) {

            /* Reduce fuente y padding encabezados */
            thead th {
                font-size: 0.75rem;
                padding: 6px 4px;
                line-height: 1.1;
            }

            /* Tabla scroll horizontal */
            table {
                min-width: 100%; /* que no crezca demasiado */
            }

            /* Oculta thead para diseño tipo "cards" */
            thead {
                display: none;
            }

            /* Cada fila ocupa todo el ancho y se muestra como bloque */
            tbody tr {
                display: block;
                margin-bottom: 20px;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
                background-color: white;
                box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
            }

            /* Cada celda se comporta como fila con etiqueta */
            tbody td {
                display: flex;
                justify-content: space-between;
                padding: 8px 10px;
                text-align: left;
                border: none;
                border-bottom: 1px solid #eee;
                font-size: 0.9rem;
                line-height: 1.3;
                word-break: break-word;
            }

            /* Última celda sin borde inferior */
            tbody td:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            /* Etiqueta (data-label) antes del valor */
            tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #333;
                flex-basis: 45%;
                white-space: normal;
                word-break: break-word;
                padding-right: 10px;
            }

            /* Botón imprimir con tamaño ajustado */
            .btn-imprimir {
                font-size: 0.85rem;
                padding: 8px 10px;
                width: 100%;
                box-sizing: border-box;
                border-radius: 6px;
            }

            /* Link volver más visible y con margen */
            .volver {
                margin-top: 40px;
                font-size: 1.1rem;
            }
        }

        /* Contenedor del "avión" */
        .bus {
            background: #e6f0ff; /* color azul claro */
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: inset 0 0 15px #aac8ff;
            max-width: 700px;
            margin: 0 auto;
            user-select: none;
        }

        /* Cada fila de asientos es un flex horizontal */
        .fila {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
            align-items: center;
        }

        /* Pasillo: espacio fijo entre asientos C y D */
        .fila > span.pasillo {
            width: 40px; /* ancho del pasillo */
        }

        /* Checkbox oculto para solo mostrar label estilizado */
        .bus input[type="checkbox"] {
            display: none;
        }

        /* Estilo base de cada asiento (label) */
        .asiento {
            width: 45px;
            height: 45px;
            background-color: #90ee90; /* verde claro para disponible */
            border-radius: 8px;
            border: 2px solid #388e3c;
            margin: 0 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: 700;
            color: #1b5e20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            user-select: none;
        }

        /* Cambia color y cursor para estados */
        .asiento.disponible:hover {
            background-color: #66bb6a;
            border-color: #2e7d32;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .asiento.reservado {
            background-color: #f0ad4e; /* naranja */
            border-color: #ec971f;
            color: #5a3b00;
            cursor: not-allowed;
            box-shadow: none;
        }

        .asiento.pagado {
            background-color: #d9534f; /* rojo */
            border-color: #b52b27;
            color: white;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Asiento seleccionado */
        .bus input[type="checkbox"]:checked + label.asiento {
            background-color: #1976d2; /* azul oscuro */
            border-color: #0d47a1;
            color: white;
            box-shadow: 0 0 10px #1565c0;
        }

        /* Pequeño "ventana" sobre cada asiento para fila+columna */
        .asiento span {
            pointer-events: none;
        }

        /* Selector de cliente (debajo asiento) */
        .form-cliente {
            text-align: center;
            margin-top: 6px;
        }

        /* Botón + Crear cliente */
        .agregar-cliente {
            font-size: 0.75rem;
            padding: 3px 6px;
            width: 100%;
        }

        /* Para el espacio del pasillo en el HTML, dale esta clase */
        /* Ejemplo: <span class="pasillo"></span> */

        /* Responsivo: reduce tamaño en móvil */
        @media (max-width: 576px) {
            .bus {
                padding: 15px 15px;
                max-width: 100%;
            }

            .asiento {
                width: 35px;
                height: 35px;
                margin: 0 3px;
                font-size: 0.8rem;
            }

            .fila > span.pasillo {
                width: 25px;
            }

            .agregar-cliente {
                font-size: 0.65rem;
                padding: 2px 4px;
            }
        }
        .airport-modal {
            background: linear-gradient(135deg, #0a2239 0%, #002b5c 100%);
            color: #e0e7ff;
            font-family: 'Orbitron', 'Courier New', Courier, monospace;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Header */
        .airport-header {
            background: #003366;
            border-bottom: 2px solid #00bcd4;
            color: #00bcd4;
            font-weight: 700;
            font-size: 1.4rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        /* Título ruta estilo pantalla de aeropuerto */
        .airport-route-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            color: #00bcd4;
            letter-spacing: 0.2em;
            text-align: center;
            text-shadow:
                    0 0 5px #00bcd4,
                    0 0 10px #00bcd4,
                    0 0 20px #00bcd4;
            margin-bottom: 15px;
        }

        /* Mapa con borde y sombra */
        .map-container {
            height: 350px;
            border: 3px solid #00bcd4;
            box-shadow:
                    0 0 15px #00bcd4;
            border-radius: 12px;
            overflow: hidden;
            background-color: #001f33;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        /* Tarjetas info vuelo */
        .info-card {
            background: #001f33;
            border-radius: 12px;
            padding: 20px;
            color: #c0eaff;
            font-size: 0.95rem;
            transition: box-shadow 0.3s ease;
            border: 1px solid #00bcd4;
        }

        .info-card:hover {
            box-shadow:
                    0 0 15px #00bcd4,
                    0 0 30px #00e5ff;
        }

        .info-card.bg-light {
            background: #004a75;
            color: #a0d8ff;
            border-color: #00bcd4;
        }

        /* Títulos info */
        .info-card-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: #00bcd4;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 1px solid #00bcd4;
            padding-bottom: 8px;
        }

        /* Listas */
        .info-list {
            list-style: none;
            padding-left: 0;
            line-height: 1.5;
        }

        .info-list li strong {
            color: #80d8ff;
        }

        /* Countdown timer */
        #cuentaRegresiva {
            font-size: 1.3rem;
            letter-spacing: 0.05em;
            text-shadow:
                    0 0 5px #ff1744,
                    0 0 10px #ff1744;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-dialog {
                max-width: 95% !important;
            }

            .airport-route-title {
                font-size: 1.4rem;
                letter-spacing: 0.1em;
            }

            .info-card {
                font-size: 0.85rem;
                padding: 15px;
            }
        }

        @media (max-width: 400px) {
            .airport-route-title {
                font-size: 1.2rem;
                letter-spacing: 0.07em;
            }
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>
<div th:replace="~{fragments/modalNuevoCliente :: modalNuevoCliente}"></div>
<div class="container filtros-container">
    <h2 class="text-center mb-4">Vuelos Disponibles</h2>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" id="filtroOrigen" class="form-control" placeholder="Filtrar por origen..." onkeyup="filtrar()" />
        </div>
        <div class="col-md-4">
            <input type="text" id="filtroDestino" class="form-control" placeholder="Filtrar por destino..." onkeyup="filtrar()" />
        </div>
        <div class="col-md-4">
            <input type="date" id="filtroFecha" class="form-control" oninput="filtrar()" />
        </div>
    </div>
</div>

<div class="table-responsive">
    <table id="tablaVuelos" class="table table-bordered text-center align-middle">
        <thead class="table-light">
        <tr>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha y Hora</th>
            <th>Capacidad</th>
            <th>Disponibles</th>
            <th>Precio</th>
            <th>Acción</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="vuelo : ${vuelos}"
            th:if="${vuelo.vueloEstado == 'ACTIVO'} and ${vuelo.vueloFechaSalida} >= ${T(java.time.LocalDateTime).now()}">
            <td data-label="Origen" th:text="${vuelo.ciudadOrigenNombre}"></td>
            <td data-label="Destino" th:text="${vuelo.ciudadDestinoNombre}"></td>
            <td data-label="Fecha y Hora" th:text="${#temporals.format(vuelo.vueloFechaSalida, 'yyyy-MM-dd HH:mm')}"></td>
            <td data-label="Capacidad" th:text="${vuelo.totalAsientos}"></td>
            <td data-label="Disponibles" th:text="${vuelo.asientosDisponibles}"></td>
            <td data-label="Precio" th:text="${vuelo.vueloValor + ' USD'}"></td>
            <td data-label="Acción">
                <button class="btn btn-primary btn-sm" th:attr="onclick=|abrirModal(${vuelo.vueloId})|">Comprar</button>
                <button class="btn btn-outline-info btn-sm mt-2 mt-md-1" th:attr="onclick=|verRutaVuelo(${vuelo.vueloId})|">Ver Ruta</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div id="referenteIdContainer" th:data-referente-id="${referenteId}" style="display:none;"></div>

<div id="modalContainer"></div>
<!-- Bootstrap & Leaflet JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Config Leaflet icon
    L.Icon.Default.mergeOptions({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png'
    });

    let map;
    const relaciones = {};

    // Abre modal de asientos y carga clientes para cada asiento
    function abrirModal(vueloId) {
        fetch('/asientos/vuelo/' + vueloId)
            .then(res => res.text())
            .then(html => {
                document.getElementById('modalContainer').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalAsientos'));
                modal.show();

                // Una vez abierto, inicializar eventos y cargar clientes por asiento
                setTimeout(() => {
                    detectarSeleccionAsientos();
                    actualizarContadorSeleccionados();
                    prepararEnvioFormulario();
                    cargarClientesPorAsientos();
                }, 300);
            });
    }

    // Carga clientes referidos para TODOS los selects de clientes en el modal de asientos
    function cargarClientesPorAsientos() {
        // Obtener todos los selects clientes por asiento
        document.querySelectorAll('select.seleccionar-cliente').forEach(select => {
            const asientoId = select.getAttribute('data-asiento-id');
            // Limpiar opciones excepto la opción "Seleccionar cliente"
            select.innerHTML = '<option value="">Seleccionar cliente</option>';

            // Aquí debes ajustar el referenteId si lo tienes dinámico, ahora fijo 1
            const referenteId = document.getElementById('referenteIdContainer').dataset.referenteId;

            fetch('/clientes/referente/' + referenteId)
                    .then(res => res.json())
                .then(data => {
                    data.forEach(cliente => {
                        const opt = document.createElement('option');
                        opt.value = cliente.clienteId;
                        opt.textContent = cliente.clienteNombre + (cliente.clienteApellido ? ' ' + cliente.clienteApellido : '');
                        select.appendChild(opt);
                    });
                })
                .catch(e => console.error("Error cargando clientes: ", e));
        });
    }

    // Detecta cuando seleccionas un asiento y muestra selector cliente
    function detectarSeleccionAsientos() {
        document.querySelectorAll('#formAsientos input[type="checkbox"][name="asientos"]').forEach(cb => {
            cb.addEventListener('change', () => {
                const asientoId = cb.getAttribute('data-asiento-id');
                const formCliente = document.getElementById('form-cliente-' + asientoId);

                if (cb.checked) {
                    formCliente.style.display = 'block';
                } else {
                    formCliente.style.display = 'none';
                    const select = document.getElementById('select-cliente-' + asientoId);
                    if (select) select.value = '';
                }

                actualizarContadorSeleccionados();
            });
        });
    }

    // Actualiza el contador de asientos seleccionados
    function actualizarContadorSeleccionados() {
        const seleccionados = document.querySelectorAll('#formAsientos input[type="checkbox"][name="asientos"]:checked').length;
        const contador = document.getElementById('contadorSeleccion');
        if (contador) contador.textContent = seleccionados;
    }

    // Limpia la selección de todos los asientos y clientes
    function limpiarSeleccion() {
        document.querySelectorAll('#formAsientos input[type="checkbox"][name="asientos"]').forEach(cb => {
            cb.checked = false;
            const asientoId = cb.getAttribute('data-asiento-id');
            const formCliente = document.getElementById('form-cliente-' + asientoId);
            if (formCliente) formCliente.style.display = 'none';

            const select = document.getElementById('select-cliente-' + asientoId);
            if (select) select.value = '';
        });
        actualizarContadorSeleccionados();
    }

    // Prepara JSON con relación asiento->cliente antes de enviar formulario
    function prepararEnvioFormulario() {
        const form = document.getElementById('formAsientos');
        if (!form) return;

        form.addEventListener('submit', function () {
            const relaciones = {};
            document.querySelectorAll('.seleccionar-cliente').forEach(select => {
                const asientoId = select.getAttribute('data-asiento-id');
                const clienteId = select.value;
                if (clienteId) relaciones[asientoId] = clienteId;
            });
            const jsonInput = document.getElementById('clientePorAsientoJson');
            if (jsonInput) jsonInput.value = JSON.stringify(relaciones);
        });
    }

    // Abre modal para crear nuevo cliente (este modal ya está en el fragment modalNuevoCliente)
    function abrirModalNuevoCliente(asientoId) {
        document.getElementById('modalAsientoId').value = asientoId;

        // Limpiar campos
        document.getElementById('inputNuevoCliente').value = '';
        document.getElementById('inputCedula').value = '';
        document.getElementById('generoM').checked = true;

        const modal = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));
        modal.show();
    }

    // Al cargar página: controlar envío formulario nuevo cliente
    document.addEventListener('DOMContentLoaded', () => {
        const formNuevoCliente = document.getElementById('formNuevoCliente');
        formNuevoCliente?.addEventListener('submit', function (e) {
            e.preventDefault();

            const nombre = document.getElementById('inputNuevoCliente').value.trim();
            const cedula = document.getElementById('inputCedula').value.trim();
            const genero = document.querySelector('input[name="genero"]:checked')?.value;
            const asientoId = document.getElementById('modalAsientoId').value;

            if (!nombre || !cedula || !genero) {
                alert("Todos los campos son obligatorios.");
                return;
            }
            const referenteId = document.getElementById('referenteIdContainer').dataset.referenteId;

            const nuevoCliente = {
                clienteReferenteId: referenteId,  // Cambia si lo quieres dinámico
                clienteNombre: nombre,
                clienteCedula: cedula,
                clienteGenero: genero,
                clienteContrasena: cedula,
                clienteUsuario: cedula,
                clienteRol: "cliente"
            };

            fetch('/clientes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoCliente)
            })
                .then(res => {
                    if (!res.ok) throw new Error("Error al guardar cliente");
                    return res.json();
                })
                .then(cliente => {
                    // Añadir cliente creado al select del asiento correspondiente
                    const sel = document.getElementById('select-cliente-' + asientoId);
                    if (sel) {
                        const opt = document.createElement('option');
                        opt.value = cliente.clienteId;
                        opt.textContent = cliente.clienteNombre + (cliente.clienteApellido ? ' ' + cliente.clienteApellido : '');
                        sel.appendChild(opt);
                        sel.value = cliente.clienteId;
                    }

                    // Cerrar modal nuevo cliente
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente')).hide();
                    alert("Cliente creado y seleccionado.");
                })
                .catch(err => {
                    console.error(err);
                    alert("Ocurrió un error al guardar el cliente.");
                });
        });
    });

    // Funciones para ver ruta vuelo, filtro, etc. (tu código actual)

    function verRutaVuelo(idVuelo) {
        fetch('/rutaVuelo/' + idVuelo)
            .then(res => res.text())
            .then(html => {
                document.getElementById('modalContainer').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalRuta'));
                modal.show();

                document.getElementById('modalRuta').addEventListener('shown.bs.modal', () => {
                    const datos = document.getElementById('datosRuta');
                    const lat1 = parseFloat(datos.dataset.latOrigen);
                    const lon1 = parseFloat(datos.dataset.lonOrigen);
                    const lat2 = parseFloat(datos.dataset.latDestino);
                    const lon2 = parseFloat(datos.dataset.lonDestino);
                    const salidaStr = datos.dataset.fechaSalida;

                    // Distancia (Haversine)
                    const distancia = calcularDistancia([lat1, lon1], [lat2, lon2]);
                    document.getElementById("distanciaCalculada").innerText = distancia + " km";

                    // Arribo estimado (asumamos 800 km/h)
                    const tiempoHoras = distancia / 800;
                    const salida = new Date(salidaStr);
                    const llegada = new Date(salida.getTime() + tiempoHoras * 60 * 60 * 1000);
                    document.getElementById("horaArribo").innerText = llegada.toLocaleString();

                    // Cuenta regresiva
                    iniciarCuentaRegresiva(salida);

                    // Ajustar mapa
                }, { once: true });
            });
    }

    function calcularDistancia(coord1, coord2) {
        const toRad = x => x * Math.PI / 180;
        const R = 6371;
        const dLat = toRad(coord2[0] - coord1[0]);
        const dLon = toRad(coord2[1] - coord1[1]);
        const lat1 = toRad(coord1[0]);
        const lat2 = toRad(coord2[0]);
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
    }
    function iniciarCuentaRegresiva(fechaSalida) {
        const salida = new Date(fechaSalida);
        const el = document.getElementById("cuentaRegresiva");

        function actualizar() {
            const ahora = new Date();
            const diff = salida - ahora;

            if (diff <= 0) {
                el.innerText = "¡El vuelo ya salió!";
                return;
            }

            const totalSegundos = Math.floor(diff / 1000);
            const dias = Math.floor(totalSegundos / 86400);
            const horas = Math.floor((totalSegundos % 86400) / 3600);
            const minutos = Math.floor((totalSegundos % 3600) / 60);
            const segundos = totalSegundos % 60;

            el.innerText = `${dias} días, ${horas}h ${minutos}m ${segundos}s`;

            setTimeout(actualizar, 1000);
        }

        actualizar();
    }


    function filtrar() {
        let origen = document.getElementById("filtroOrigen").value.toLowerCase();
        let destino = document.getElementById("filtroDestino").value.toLowerCase();
        let fecha = document.getElementById("filtroFecha").value;
        let filas = document.querySelectorAll("#tablaVuelos tbody tr");

        filas.forEach(fila => {
            let td = fila.querySelectorAll("td");
            let textoOrigen = td[0]?.innerText.toLowerCase() || "";
            let textoDestino = td[1]?.innerText.toLowerCase() || "";
            let textoFecha = td[2]?.innerText.slice(0, 10) || "";
            let coincideOrigen = textoOrigen.includes(origen);
            let coincideDestino = textoDestino.includes(destino);
            let coincideFecha = !fecha || textoFecha === fecha;
            fila.style.display = (coincideOrigen && coincideDestino && coincideFecha) ? "" : "none";
        });
    }

</script>
</body>
</html>
